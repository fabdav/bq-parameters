<!DOCTYPE html>
<html>
<head>
  <title>Update Project Dates</title>
</head>
<body>
  <h2>Project Date Form</h2>

  <!-- Existing Projects -->
  <label for="projectSelect">Select Project:</label>
  <select id="projectSelect"></select>
  <br><br>

  <label for="projectDate">Date:</label>
  <input type="date" id="projectDate">
  <button onclick="updateProject()">Update Existing Project</button>
  <br><br>

  <!-- Add New Project -->
  <label for="newProject">Add New Project:</label>
  <input type="text" id="newProject" placeholder="Project name">
  <input type="date" id="newProjectDate">
  <button onclick="addProject()">Add New Project</button>

  <script>
    // ⚠️ Your GitHub token (keep it secret)
    const token = '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';

    // Repository info
    const repo = 'fabdav/bq-parameters'; // username/repo
    const filePath = 'project.csv';      // CSV path
    const branch = 'main';
    const apiUrl = `https://api.github.com/repos/${repo}/contents/${filePath}`;
    const rawUrl = `https://raw.githubusercontent.com/${repo}/${branch}/${filePath}`;

    let projects = {};

    // Load CSV into dropdown
    fetch(rawUrl)
      .then(res => res.text())
      .then(text => {
        const lines = text.trim().split('\n');
        lines.slice(1).forEach(line => {
          const [proj, date] = line.split(',');
          projects[proj] = date;
        });
        populateDropdown();
      });

    function populateDropdown() {
      const select = document.getElementById('projectSelect');
      select.innerHTML = '';
      for (const proj in projects) {
        const option = document.createElement('option');
        option.value = proj;
        option.text = `${proj} (${projects[proj]})`;
        select.add(option);
      }
    }

    function updateProject() {
      const proj = document.getElementById('projectSelect').value;
      const date = document.getElementById('projectDate').value;
      if (!proj || !date) { alert('Select project and date'); return; }
      projects[proj] = date;
      saveCSV();
    }

    function addProject() {
      const proj = document.getElementById('newProject').value;
      const date = document.getElementById('newProjectDate').value;
      if (!proj || !date) { alert('Enter project name and date'); return; }
      projects[proj] = date;
      saveCSV();
    }

    async function saveCSV() {
      let content = 'project,date\n';
      for (const p in projects) {
        content += `${p},${projects[p]}\n`;
      }
      const fileBase64 = btoa(content);

      // Step 1: Get current SHA
      const getRes = await fetch(apiUrl, {
        headers: { 'Authorization': `token ${token}` }
      });
      if (!getRes.ok) { alert('Error getting file metadata'); return; }
      const fileData = await getRes.json();
      const sha = fileData.sha;

      // Step 2: Update CSV
      const res = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'Update project.csv',
          content: fileBase64,
          branch: branch,
          sha: sha
        })
      });

      if (res.ok) {
        alert('CSV updated successfully!');
        populateDropdown();
      } else {
        alert('Error updating CSV');
        console.log(await res.text());
      }
    }
  </script>
</body>
</html>
