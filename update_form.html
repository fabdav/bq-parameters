<!DOCTYPE html>
<html>
<head>
  <title>Update Project Dates</title>
  <style>
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    th { background-color: #f2f2f2; }
    input[type="date"] { width: 130px; }
  </style>
</head>
<body>
  <h2>Project Date Manager</h2>

  <h3>Existing Projects</h3>
  <table id="projectsTable">
    <thead>
      <tr>
        <th>Project</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <br>

  <h3>Add New Project</h3>
  <label>Project Name: </label>
  <input type="text" id="newProject" placeholder="Project name">
  <label>Date: </label>
  <input type="date" id="newProjectDate">
  <button onclick="addProject()">Add Project</button>

  <br><br>
  <button onclick="saveAll()">Save All Changes</button>

  <script>
    // GitHub repo info
    const token = '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';
    const repo = 'fabdav/bq-parameters';
    const filePath = 'projects.csv';
    const branch = 'main';
    const rawUrl = `https://raw.githubusercontent.com/${repo}/${branch}/${filePath}`;

    let projects = {}; // { projectName: date }

    // Load CSV from GitHub
    fetch(rawUrl)
      .then(res => res.text())
      .then(text => {
        const lines = text.trim().split('\n');
        lines.slice(1).forEach(line => {
          const [proj, date] = line.split(',');
          projects[proj] = date;
        });
        renderTable();
      });

    // Render table of projects
    function renderTable() {
      const tbody = document.getElementById('projectsTable').getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      for (const proj in projects) {
        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = proj;
        tr.appendChild(tdName);

        const tdDate = document.createElement('td');
        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.value = projects[proj];
        dateInput.onchange = (e) => projects[proj] = e.target.value;
        tdDate.appendChild(dateInput);
        tr.appendChild(tdDate);

        tbody.appendChild(tr);
      }
    }

    // Add new project
    function addProject() {
      const name = document.getElementById('newProject').value.trim();
      const date = document.getElementById('newProjectDate').value;
      if (!name || !date) { alert('Enter project name and date'); return; }
      projects[name] = date;
      document.getElementById('newProject').value = '';
      document.getElementById('newProjectDate').value = '';
      renderTable();
    }

    // Save all changes to GitHub
    async function saveAll() {
      let content = 'project,date\n';
      for (const p in projects) {
        content += `${p},${projects[p]}\n`;
      }
      const fileBase64 = btoa(content);

      const apiUrl = `https://api.github.com/repos/${repo}/contents/${filePath}`;
      try {
        const res = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Update projects.csv',
            content: fileBase64,
            branch: branch
          })
        });
        if (res.ok) {
          alert('All changes saved!');
        } else {
          const errorText = await res.text();
          alert('Error saving CSV');
          console.log(errorText);
        }
      } catch (err) {
        alert('Request failed');
        console.log(err);
      }
    }
  </script>
</body>
</html>
